From f6af183aed5872d57cf2c9d435dfd8d2e9239e69 Mon Sep 17 00:00:00 2001
From: rudiwawa <rudiwawa1980@gmail.com>
Date: Fri, 16 Aug 2019 11:34:06 +0700
Subject: [PATCH] menambah keamanan api

---
 application/controllers/Api_jenis_fasilitas.php   |  6 ++++++
 application/controllers/Api_jenis_pariwisata.php  |  6 ++++++
 application/controllers/Api_konten_fasilitas.php  |  7 +++++++
 application/controllers/Api_konten_pariwisata.php |  8 ++++++++
 application/controllers/Api_sub_fasilitas.php     |  6 ++++++
 application/controllers/Api_sub_pariwisata.php    |  6 ++++++
 application/controllers/Welcome.php               |  2 ++
 application/views/template/footer.php             |  4 +++-
 assets/myjs/app.js                                |  7 ++++++-
 assets/myjs/md5.js                                | 14 ++++++++++++++
 assets/xcatatan.txt                               |  0
 11 files changed, 64 insertions(+), 2 deletions(-)
 create mode 100644 assets/myjs/md5.js
 create mode 100644 assets/xcatatan.txt

diff --git a/application/controllers/Api_jenis_fasilitas.php b/application/controllers/Api_jenis_fasilitas.php
index 166522f..faf246a 100644
--- a/application/controllers/Api_jenis_fasilitas.php
+++ b/application/controllers/Api_jenis_fasilitas.php
@@ -22,6 +22,12 @@ class Api_jenis_fasilitas extends \Restserver\Libraries\REST_Controller
         $this->methods['users_delete']['limit'] = 50; // 50 requests per hour per user/key
         date_default_timezone_set('Asia/Jakarta');
         $this->now = date('Y-m-d H:i:s');
+        $header_auth = $this->input->request_headers();
+        // var_dump($header_auth['eek']);
+        // var_dump(md5($_SESSION["token"]."tp"));
+        if ($header_auth['eek']!=md5($_SESSION["token"]."tp")) {
+            redirect("/notfound");
+        }
     }
 
     public function index_get()
diff --git a/application/controllers/Api_jenis_pariwisata.php b/application/controllers/Api_jenis_pariwisata.php
index 98f3456..464b3fc 100644
--- a/application/controllers/Api_jenis_pariwisata.php
+++ b/application/controllers/Api_jenis_pariwisata.php
@@ -22,6 +22,12 @@ class Api_jenis_pariwisata extends \Restserver\Libraries\REST_Controller
         $this->methods['users_delete']['limit'] = 50; // 50 requests per hour per user/key
         date_default_timezone_set('Asia/Jakarta');
         $this->now = date('Y-m-d H:i:s');
+        $header_auth = $this->input->request_headers();
+        // var_dump($header_auth['eek']);
+        // var_dump(md5($_SESSION["token"]."tp"));
+        if ($header_auth['eek']!=md5($_SESSION["token"]."tp")) {
+            redirect("/notfound");
+        }
     }
 
     public function index_get()
diff --git a/application/controllers/Api_konten_fasilitas.php b/application/controllers/Api_konten_fasilitas.php
index 9d063bf..72fd059 100644
--- a/application/controllers/Api_konten_fasilitas.php
+++ b/application/controllers/Api_konten_fasilitas.php
@@ -22,6 +22,13 @@ class Api_konten_fasilitas extends \Restserver\Libraries\REST_Controller
         $this->methods['users_delete']['limit'] = 50; // 50 requests per hour per user/key
         date_default_timezone_set('Asia/Jakarta');
         $this->now = date('Y-m-d H:i:s');
+
+        $header_auth = $this->input->request_headers();
+        // var_dump($header_auth['eek']);
+        // var_dump(md5($_SESSION["token"]."tp"));
+        if ($header_auth['eek']!=md5($_SESSION["token"]."tp")) {
+            redirect("/notfound");
+        }
     }
     public function validate_phone($str)
     {
diff --git a/application/controllers/Api_konten_pariwisata.php b/application/controllers/Api_konten_pariwisata.php
index 25501e1..0ad9bee 100644
--- a/application/controllers/Api_konten_pariwisata.php
+++ b/application/controllers/Api_konten_pariwisata.php
@@ -22,6 +22,14 @@ class Api_konten_pariwisata extends \Restserver\Libraries\REST_Controller
         $this->methods['users_delete']['limit'] = 50; // 50 requests per hour per user/key
         date_default_timezone_set('Asia/Jakarta');
         $this->now = date('Y-m-d H:i:s');
+        $header_auth = $this->input->request_headers();
+        // var_dump($header_auth['eek']);
+        // var_dump(md5($_SESSION["token"]."tp"));
+        if ($header_auth['eek']!=md5($_SESSION["token"]."tp")) {
+            redirect("/notfound");
+        }
+        // var_dump($this->input->request_headers());
+        // var_dump($this->input->is_ajax_request());
     }
     public function validate_phone($str)
     {
diff --git a/application/controllers/Api_sub_fasilitas.php b/application/controllers/Api_sub_fasilitas.php
index d801d27..d38b2f8 100644
--- a/application/controllers/Api_sub_fasilitas.php
+++ b/application/controllers/Api_sub_fasilitas.php
@@ -22,6 +22,12 @@ class Api_sub_fasilitas extends \Restserver\Libraries\REST_Controller
         $this->methods['users_delete']['limit'] = 50; // 50 requests per hour per user/key
         date_default_timezone_set('Asia/Jakarta');
         $this->now = date('Y-m-d H:i:s');
+        $header_auth = $this->input->request_headers();
+        // var_dump($header_auth['eek']);
+        // var_dump(md5($_SESSION["token"]."tp"));
+        if ($header_auth['eek']!=md5($_SESSION["token"]."tp")) {
+            redirect("/notfound");
+        }
     }
 
     public function index_get()
diff --git a/application/controllers/Api_sub_pariwisata.php b/application/controllers/Api_sub_pariwisata.php
index 01aee48..cb6247a 100644
--- a/application/controllers/Api_sub_pariwisata.php
+++ b/application/controllers/Api_sub_pariwisata.php
@@ -22,6 +22,12 @@ class Api_sub_pariwisata extends \Restserver\Libraries\REST_Controller
         $this->methods['users_delete']['limit'] = 50; // 50 requests per hour per user/key
         date_default_timezone_set('Asia/Jakarta');
         $this->now = date('Y-m-d H:i:s');
+        $header_auth = $this->input->request_headers();
+        // var_dump($header_auth['eek']);
+        // var_dump(md5($_SESSION["token"]."tp"));
+        if ($header_auth['eek']!=md5($_SESSION["token"]."tp")) {
+            redirect("/notfound");
+        }
     }
 
     public function index_get()
diff --git a/application/controllers/Welcome.php b/application/controllers/Welcome.php
index cb3c3aa..b85fd6b 100644
--- a/application/controllers/Welcome.php
+++ b/application/controllers/Welcome.php
@@ -6,6 +6,8 @@ class Welcome extends CI_Controller {
 
 	public function index()
 	{
+		$_SESSION["token"]=md5(uniqid(rand(), true));
+		// echo md5($_SESSION["token"]."tp");
 		$ready = true;
 		if($ready ){
 			$this->load->view('template/header', [
diff --git a/application/views/template/footer.php b/application/views/template/footer.php
index 355a158..6d5ff97 100644
--- a/application/views/template/footer.php
+++ b/application/views/template/footer.php
@@ -8,6 +8,8 @@ defined('BASEPATH') OR exit('No direct script access allowed');
 
 <?php if($jquery):?>
     <script src='<?=base_url()?>assets/assets/plugins/jquery/jquery.min.js'></script>
+    <script src='<?=base_url()?>assets/myjs/md5.js'>
+    </script>
 <?php endif; ?>
 
 
@@ -53,7 +55,7 @@ defined('BASEPATH') OR exit('No direct script access allowed');
     <script src="<?=base_url()?>assets/assets/plugins/styleswitcher/jQuery.style.switcher.js"></script>
 <?php endif; ?>
 
-
+    <script>window.bashUrl = "<?php echo $_SESSION['token']?>";</script>
     <script src="<?=base_url()?>assets/assets/plugins/datatables/jquery.dataTables.min.js"></script>
     <script src="<?=base_url()?>assets/myjs/compress.js"></script>
     <?php if($app): ?>
diff --git a/assets/myjs/app.js b/assets/myjs/app.js
index 34fff32..23b7024 100644
--- a/assets/myjs/app.js
+++ b/assets/myjs/app.js
@@ -1,7 +1,12 @@
 $(document).ready(function () {
 
 	// $('#modal_crop').modal('hide');
-
+	console.log(window.bashUrl);
+	console.log();
+	var key = "tp";
+	$.ajaxSetup({
+		headers: { 'eek': $.md5(window.bashUrl+key) }       
+	});
 	// CONFIG URL AP
 	window.bashUrl = "/app";
 	window.url = new Array();
diff --git a/assets/myjs/md5.js b/assets/myjs/md5.js
new file mode 100644
index 0000000..4493d9c
--- /dev/null
+++ b/assets/myjs/md5.js
@@ -0,0 +1,14 @@
+(function($){$.md5=function(string){function RotateLeft(lValue,iShiftBits){return(lValue<<iShiftBits)|(lValue>>>(32-iShiftBits));}
+function AddUnsigned(lX,lY){var lX4,lY4,lX8,lY8,lResult;lX8=(lX&0x80000000);lY8=(lY&0x80000000);lX4=(lX&0x40000000);lY4=(lY&0x40000000);lResult=(lX&0x3FFFFFFF)+(lY&0x3FFFFFFF);if(lX4&lY4){return(lResult^0x80000000^lX8^lY8);}
+if(lX4|lY4){if(lResult&0x40000000){return(lResult^0xC0000000^lX8^lY8);}else{return(lResult^0x40000000^lX8^lY8);}}else{return(lResult^lX8^lY8);}}
+function F(x,y,z){return(x&y)|((~x)&z);}
+function G(x,y,z){return(x&z)|(y&(~z));}
+function H(x,y,z){return(x^y^z);}
+function I(x,y,z){return(y^(x|(~z)));}
+function FF(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);};function GG(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);};function HH(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);};function II(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);};function ConvertToWordArray(string){var lWordCount;var lMessageLength=string.length;var lNumberOfWords_temp1=lMessageLength+8;var lNumberOfWords_temp2=(lNumberOfWords_temp1-(lNumberOfWords_temp1%64))/64;var lNumberOfWords=(lNumberOfWords_temp2+1)*16;var lWordArray=Array(lNumberOfWords-1);var lBytePosition=0;var lByteCount=0;while(lByteCount<lMessageLength){lWordCount=(lByteCount-(lByteCount%4))/4;lBytePosition=(lByteCount%4)*8;lWordArray[lWordCount]=(lWordArray[lWordCount]|(string.charCodeAt(lByteCount)<<lBytePosition));lByteCount++;}
+lWordCount=(lByteCount-(lByteCount%4))/4;lBytePosition=(lByteCount%4)*8;lWordArray[lWordCount]=lWordArray[lWordCount]|(0x80<<lBytePosition);lWordArray[lNumberOfWords-2]=lMessageLength<<3;lWordArray[lNumberOfWords-1]=lMessageLength>>>29;return lWordArray;};function WordToHex(lValue){var WordToHexValue="",WordToHexValue_temp="",lByte,lCount;for(lCount=0;lCount<=3;lCount++){lByte=(lValue>>>(lCount*8))&255;WordToHexValue_temp="0"+lByte.toString(16);WordToHexValue=WordToHexValue+WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);}
+return WordToHexValue;};function Utf8Encode(string){string=string.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c);}
+else if((c>127)&&(c<2048)){utftext+=String.fromCharCode((c>>6)|192);utftext+=String.fromCharCode((c&63)|128);}
+else{utftext+=String.fromCharCode((c>>12)|224);utftext+=String.fromCharCode(((c>>6)&63)|128);utftext+=String.fromCharCode((c&63)|128);}}
+return utftext;};var x=Array();var k,AA,BB,CC,DD,a,b,c,d;var S11=7,S12=12,S13=17,S14=22;var S21=5,S22=9,S23=14,S24=20;var S31=4,S32=11,S33=16,S34=23;var S41=6,S42=10,S43=15,S44=21;string=Utf8Encode(string);x=ConvertToWordArray(string);a=0x67452301;b=0xEFCDAB89;c=0x98BADCFE;d=0x10325476;for(k=0;k<x.length;k+=16){AA=a;BB=b;CC=c;DD=d;a=FF(a,b,c,d,x[k+0],S11,0xD76AA478);d=FF(d,a,b,c,x[k+1],S12,0xE8C7B756);c=FF(c,d,a,b,x[k+2],S13,0x242070DB);b=FF(b,c,d,a,x[k+3],S14,0xC1BDCEEE);a=FF(a,b,c,d,x[k+4],S11,0xF57C0FAF);d=FF(d,a,b,c,x[k+5],S12,0x4787C62A);c=FF(c,d,a,b,x[k+6],S13,0xA8304613);b=FF(b,c,d,a,x[k+7],S14,0xFD469501);a=FF(a,b,c,d,x[k+8],S11,0x698098D8);d=FF(d,a,b,c,x[k+9],S12,0x8B44F7AF);c=FF(c,d,a,b,x[k+10],S13,0xFFFF5BB1);b=FF(b,c,d,a,x[k+11],S14,0x895CD7BE);a=FF(a,b,c,d,x[k+12],S11,0x6B901122);d=FF(d,a,b,c,x[k+13],S12,0xFD987193);c=FF(c,d,a,b,x[k+14],S13,0xA679438E);b=FF(b,c,d,a,x[k+15],S14,0x49B40821);a=GG(a,b,c,d,x[k+1],S21,0xF61E2562);d=GG(d,a,b,c,x[k+6],S22,0xC040B340);c=GG(c,d,a,b,x[k+11],S23,0x265E5A51);b=GG(b,c,d,a,x[k+0],S24,0xE9B6C7AA);a=GG(a,b,c,d,x[k+5],S21,0xD62F105D);d=GG(d,a,b,c,x[k+10],S22,0x2441453);c=GG(c,d,a,b,x[k+15],S23,0xD8A1E681);b=GG(b,c,d,a,x[k+4],S24,0xE7D3FBC8);a=GG(a,b,c,d,x[k+9],S21,0x21E1CDE6);d=GG(d,a,b,c,x[k+14],S22,0xC33707D6);c=GG(c,d,a,b,x[k+3],S23,0xF4D50D87);b=GG(b,c,d,a,x[k+8],S24,0x455A14ED);a=GG(a,b,c,d,x[k+13],S21,0xA9E3E905);d=GG(d,a,b,c,x[k+2],S22,0xFCEFA3F8);c=GG(c,d,a,b,x[k+7],S23,0x676F02D9);b=GG(b,c,d,a,x[k+12],S24,0x8D2A4C8A);a=HH(a,b,c,d,x[k+5],S31,0xFFFA3942);d=HH(d,a,b,c,x[k+8],S32,0x8771F681);c=HH(c,d,a,b,x[k+11],S33,0x6D9D6122);b=HH(b,c,d,a,x[k+14],S34,0xFDE5380C);a=HH(a,b,c,d,x[k+1],S31,0xA4BEEA44);d=HH(d,a,b,c,x[k+4],S32,0x4BDECFA9);c=HH(c,d,a,b,x[k+7],S33,0xF6BB4B60);b=HH(b,c,d,a,x[k+10],S34,0xBEBFBC70);a=HH(a,b,c,d,x[k+13],S31,0x289B7EC6);d=HH(d,a,b,c,x[k+0],S32,0xEAA127FA);c=HH(c,d,a,b,x[k+3],S33,0xD4EF3085);b=HH(b,c,d,a,x[k+6],S34,0x4881D05);a=HH(a,b,c,d,x[k+9],S31,0xD9D4D039);d=HH(d,a,b,c,x[k+12],S32,0xE6DB99E5);c=HH(c,d,a,b,x[k+15],S33,0x1FA27CF8);b=HH(b,c,d,a,x[k+2],S34,0xC4AC5665);a=II(a,b,c,d,x[k+0],S41,0xF4292244);d=II(d,a,b,c,x[k+7],S42,0x432AFF97);c=II(c,d,a,b,x[k+14],S43,0xAB9423A7);b=II(b,c,d,a,x[k+5],S44,0xFC93A039);a=II(a,b,c,d,x[k+12],S41,0x655B59C3);d=II(d,a,b,c,x[k+3],S42,0x8F0CCC92);c=II(c,d,a,b,x[k+10],S43,0xFFEFF47D);b=II(b,c,d,a,x[k+1],S44,0x85845DD1);a=II(a,b,c,d,x[k+8],S41,0x6FA87E4F);d=II(d,a,b,c,x[k+15],S42,0xFE2CE6E0);c=II(c,d,a,b,x[k+6],S43,0xA3014314);b=II(b,c,d,a,x[k+13],S44,0x4E0811A1);a=II(a,b,c,d,x[k+4],S41,0xF7537E82);d=II(d,a,b,c,x[k+11],S42,0xBD3AF235);c=II(c,d,a,b,x[k+2],S43,0x2AD7D2BB);b=II(b,c,d,a,x[k+9],S44,0xEB86D391);a=AddUnsigned(a,AA);b=AddUnsigned(b,BB);c=AddUnsigned(c,CC);d=AddUnsigned(d,DD);}
+var temp=WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d);return temp.toLowerCase();};})(jQuery);
\ No newline at end of file
diff --git a/assets/xcatatan.txt b/assets/xcatatan.txt
new file mode 100644
index 0000000..e69de29
-- 
2.17.1.windows.2

